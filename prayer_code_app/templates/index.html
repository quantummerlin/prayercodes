{% extends 'base.html' %}
{% block content %}
<div class="tagline text-center">
  <p id="tagline">Create structured prayers inspired by scripture, generate your Prayer Code, and connect to the Kingdom of Heaven.</p>
</div>

<div class="card">
  <h2 class="text-center">Build Your Prayer</h2>
  <p class="text-center">Select a prayer category to begin your journey</p>
  
  <div class="prayer-categories">
    <div class="category-card" data-category="model_prayer">
      <div class="category-icon">üôè</div>
      <div class="category-name">Model Prayer</div>
    </div>
    <div class="category-card" data-category="protection">
      <div class="category-icon">üõ°Ô∏è</div>
      <div class="category-name">Protection</div>
    </div>
    <div class="category-card" data-category="thanksgiving">
      <div class="category-icon">‚ù§Ô∏è</div>
      <div class="category-name">Thanksgiving</div>
    </div>
    <div class="category-card" data-category="petition">
      <div class="category-icon">üìù</div>
      <div class="category-name">Petition</div>
    </div>
    <div class="category-card" data-category="guidance">
      <div class="category-icon">üîç</div>
      <div class="category-name">Guidance</div>
    </div>
    <div class="category-card" data-category="healing">
      <div class="category-icon">üåø</div>
      <div class="category-name">Healing</div>
    </div>
    <div class="category-card" data-category="justice">
      <div class="category-icon">‚öñÔ∏è</div>
      <div class="category-name">Justice</div>
    </div>
  </div>
</div>

<div id="prayer-builder" class="card" style="display: none;">
  <h2 class="text-center">Prayer Builder</h2>
  <div id="prayer-steps-container">
    <!-- Prayer steps will be inserted here dynamically -->
  </div>
  
  <div class="button-container">
    <button id="preview-prayer" class="button">Preview Prayer</button>
  </div>
</div>

<div id="prayer-preview-card" class="card" style="display: none;">
  <h2 class="text-center">Your Prayer</h2>
  <div class="prayer-preview">
    <h3 class="prayer-preview-title">Prayer Preview</h3>
    <div id="prayer-preview-text"></div>
  </div>
  
  <div class="button-container">
    <button id="edit-prayer" class="button" style="margin-right: 10px;">Edit Prayer</button>
    <button id="generate-code" class="button">Generate Code</button>
  </div>
</div>

<div id="prayer-code-card" class="card" style="display: none;">
  <h2 class="text-center">Your Prayer Code</h2>
  <div class="code-display" id="prayer-code"></div>
  
  <div class="share-section">
    <h3 class="text-center">Amplify Your Prayer Code</h3>
    <p class="text-center">Share your code and listen to the creation frequency (37-73 Hz) to strengthen your connection to Heaven.</p>
    
    <div class="social-share">
      <a href="#" class="social-button share-primary" id="native-share">
        <span>üì§ Share Prayer Code</span>
      </a>
      <a href="#" class="social-button" id="share-whatsapp">
        <span>üí¨ WhatsApp</span>
      </a>
      <a href="#" class="social-button" id="copy-code">
        <img src="{{ url_for('static', filename='icons/copy.svg') }}" alt="Copy" class="social-icon">
        <span>Copy Code</span>
      </a>
      <a href="#" class="social-button" id="share-facebook">
        <img src="{{ url_for('static', filename='icons/facebook.svg') }}" alt="Facebook" class="social-icon">
        <span>Facebook</span>
      </a>
      <a href="#" class="social-button" id="share-twitter">
        <img src="{{ url_for('static', filename='icons/twitter.svg') }}" alt="Twitter" class="social-icon">
        <span>Twitter</span>
      </a>
    </div>
    
    <div class="amplify-section">
      <h3 class="text-center">Listen to Creation Frequency</h3>
      <p class="text-center">Focus on your prayer while listening to the 37-73 Hz creation frequency</p>
      
      <div class="frequency-player">
        <div class="audio-player">
          <audio controls id="creation-frequency">
            <source src="{{ url_for('static', filename='audio/creation-frequency.mp3') }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        </div>
        <div class="frequency-info">
          <p>The 37-73 Hz frequency is known as the "Sound of Creation" - it helps amplify your prayers and connect to the Kingdom of Heaven.</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="button-container">
    <button id="new-prayer" class="button">Create New Prayer</button>
  </div>
</div>

<div class="card">
  <h3 class="text-center">Prayer Guidance</h3>
  <div class="scripture-quote">
    "But when ye pray, use not vain repetitions, as the heathen do: for they think that they shall be heard for their much speaking."
    <div class="scripture-reference">Matthew 6:7 (KJV)</div>
  </div>
  
  <p class="text-center">
    Prayer is your direct connection to God. The structure helps guide your heart, but the sincerity of your faith is what matters most.
  </p>
  
  <div class="scripture-quote">
    "Let us therefore come boldly unto the throne of grace, that we may obtain mercy, and find grace to help in time of need."
    <div class="scripture-reference">Hebrews 4:16 (KJV)</div>
  </div>
</div>

<div id="prayer-history-card" class="card">
  <h2 class="text-center">My Prayer Journal</h2>
  <p class="text-center" id="history-empty">Your saved prayers will appear here</p>
  <div id="prayer-history-list"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Prayer category flows - structured prayer templates
const categoryFlows = {
  "model_prayer": [
    {"key": "adoration", "prompt": "üôè Our Father which art in heaven üôè", "guidance": "Begin by honoring God", "scripture": "Hallowed be thy name. (Matthew 6:9 KJV)", "example": "Example: 'Heavenly Father, You are holy and loving, and I am always held in Your care.'"},
    {"key": "align_will", "prompt": "üôè Thy kingdom come, Thy will be done üôè", "guidance": "Ask for God's guidance and plan to be done in your life", "scripture": "Thy will be done in earth, as it is in heaven. (Matthew 6:10 KJV)", "example": "Example: 'Your will is done in my life and I walk in Your purpose.'"},
    {"key": "petition", "prompt": "üôè Give us this day our daily bread üôè", "guidance": "Ask for what you need today", "scripture": "Give us this day our daily bread. (Matthew 6:11 KJV)", "example": "Example: 'My schoolwork is blessed and I have all I need today.'"},
    {"key": "repentance", "prompt": "üôè And forgive us our debts, as we forgive our debtors üôè", "guidance": "Confess and forgive", "scripture": "And forgive us our debts, as we forgive our debtors. (Matthew 6:12 KJV)", "example": "Example: 'I am forgiven and I freely forgive others.'"},
    {"key": "protection", "prompt": "üôè And lead us not into temptation, but deliver us from evil üôè", "guidance": "Ask for God's protection", "scripture": "And lead us not into temptation, but deliver us from evil. (Matthew 6:13 KJV)", "example": "Example: 'I am protected and I make wise choices every day.'"},
    {"key": "closing", "prompt": "üôè Amen üôè", "guidance": "Seal your prayer with faith", "scripture": "", "example": "Example: 'Amen.'"}
  ],
  "protection": [
    {"key": "address", "prompt": "üõ°Ô∏è Talk to God / Address Him üõ°Ô∏è", "guidance": "Begin with trust.", "scripture": "God is our refuge and strength, a very present help in trouble. (Psalm 46:1 KJV)", "example": "Example: 'Dear God, I trust in Your power to keep me safe.'"},
    {"key": "problem", "prompt": "üõ°Ô∏è State the Problem / Specific Need üõ°Ô∏è", "guidance": "Describe your need.", "scripture": "The LORD shall preserve thee from all evil: he shall preserve thy soul. (Psalm 121:7 KJV)", "example": "Example: 'I am kept safe when travelling alone.'"},
    {"key": "appeal", "prompt": "üõ°Ô∏è Appeal to God's Character üõ°Ô∏è", "guidance": "Recall God's protection.", "scripture": "The name of the LORD is a strong tower: the righteous runneth into it, and is safe. (Proverbs 18:10 KJV)", "example": "Example: 'You keep me safe and I am always watched over.'"},
    {"key": "request", "prompt": "üõ°Ô∏è Request Action üõ°Ô∏è", "guidance": "Ask God to act.", "scripture": "Be careful for nothing; but in every thing by prayer and supplication with thanksgiving let your requests be made known unto God. (Philippians 4:6 KJV)", "example": "Example: 'Your protection and peace fill me now.'"},
    {"key": "praise", "prompt": "üõ°Ô∏è Praise / Declare Faith üõ°Ô∏è", "guidance": "Seal your prayer.", "scripture": "Let every thing that hath breath praise the LORD. (Psalm 150:6 KJV)", "example": "Example: 'Thank You for helping me and always being with me.'"},
    {"key": "closing", "prompt": "üõ°Ô∏è Amen üõ°Ô∏è", "guidance": "Seal your prayer.", "scripture": "", "example": "Example: 'Amen. I know You hear me.'"}
  ],
  "thanksgiving": [
    {"key": "praise", "prompt": "‚ù§Ô∏è Praise / Thank God ‚ù§Ô∏è", "guidance": "Begin with thanks.", "scripture": "In every thing give thanks: for this is the will of God in Christ Jesus concerning you. (1 Thessalonians 5:18 KJV)", "example": "Example: 'Thank You for loving me. Your goodness surrounds me.'"},
    {"key": "blessing", "prompt": "‚ù§Ô∏è State Specific Blessing ‚ù§Ô∏è", "guidance": "Name your blessing.", "scripture": "Bless the LORD, O my soul: and all that is within me, bless his holy name. (Psalm 103:1 KJV)", "example": "Example: 'My family and friends are blessed and I am always grateful.'"},
    {"key": "gratitude", "prompt": "‚ù§Ô∏è End with Praise / Gratitude ‚ù§Ô∏è", "guidance": "Seal your prayer.", "scripture": "I will offer to thee the sacrifice of thanksgiving, and will call upon the name of the LORD. (Psalm 116:17 KJV)", "example": "Example: 'I am grateful for all You do and I see Your blessings every day.'"},
    {"key": "closing", "prompt": "‚ù§Ô∏è Amen ‚ù§Ô∏è", "guidance": "Seal your prayer.", "scripture": "", "example": "Example: 'Amen.'"}
  ],
  "petition": [
    {"key": "adoration", "prompt": "üôè Adoration üôè", "guidance": "Begin with adoration.", "scripture": "Great is the LORD, and greatly to be praised. (Psalm 145:3 KJV)", "example": "Example: 'God, You are great and powerful, and I am always blessed.'"},
    {"key": "confession", "prompt": "üôè Confession (if applicable) üôè", "guidance": "Confess if needed.", "scripture": "If we confess our sins, he is faithful and just to forgive us our sins, and to cleanse us from all unrighteousness. (1 John 1:9 KJV)", "example": "Example: 'I am forgiven and I walk in freedom.'"},
    {"key": "thanksgiving", "prompt": "üôè Thanksgiving üôè", "guidance": "Thank God.", "scripture": "In every thing give thanks: for this is the will of God in Christ Jesus concerning you. (1 Thessalonians 5:18 KJV)", "example": "Example: 'Thank You for helping me. All my needs are met.'"},
    {"key": "supplication", "prompt": "üôè Supplication / Request üôè", "guidance": "Ask for what you need.", "scripture": "Ask, and it shall be given you; seek, and ye shall find; knock, and it shall be opened unto you. (Matthew 7:7 KJV)", "example": "Example: 'I am successful in my game and You are always with me.'"},
    {"key": "closing", "prompt": "üôè Amen üôè", "guidance": "Seal your prayer.", "scripture": "", "example": "Example: 'Amen.'"}
  ],
  "guidance": [
    {"key": "adoration", "prompt": "üîç Adoration üîç", "guidance": "Begin with adoration.", "scripture": "Now faith is the substance of things hoped for, the evidence of things not seen. (Hebrews 11:1 KJV)", "example": "Example: 'God, You know everything and I am always guided by You.'"},
    {"key": "need", "prompt": "üîç State Need / Problem üîç", "guidance": "Describe your need.", "scripture": "He healeth the broken in heart, and bindeth up their wounds. (Psalm 147:3 KJV)", "example": "Example: 'I make wise decisions and You lead me every day.'"},
    {"key": "appeal_wisdom", "prompt": "üîç Appeal to God's Wisdom üîç", "guidance": "Ask for wisdom.", "scripture": "If any of you lack wisdom, let him ask of God, that giveth to all men liberally, and upbraideth not; and it shall be given him. (James 1:5 KJV)", "example": "Example: 'I have wisdom for my choices and I am always confident.'"},
    {"key": "request_guidance", "prompt": "üîç Request Guidance üîç", "guidance": "Ask for guidance.", "scripture": "Trust in the LORD with all thine heart; and lean not unto thine own understanding. (Proverbs 3:5 KJV)", "example": "Example: 'I am guided in what to do and I trust Your leading every moment.'"},
    {"key": "declare_trust", "prompt": "üîç Declare Trust üîç", "guidance": "Seal your prayer.", "scripture": "Fear thou not; for I am with thee. (Isaiah 41:10 KJV)", "example": "Example: 'I trust You, God, and I am always secure.'"},
    {"key": "closing", "prompt": "üîç Amen üîç", "guidance": "Seal your prayer.", "scripture": "", "example": "Example: 'Amen.'"}
  ],
  "healing": [
    {"key": "adoration", "prompt": "üåø Adoration üåø", "guidance": "Begin with adoration.", "scripture": "The LORD is nigh unto them that are of a broken heart. (Psalm 34:18 KJV)", "example": "Example: 'God, You care for me and I am always healed.'"},
    {"key": "confession", "prompt": "üåø Confession üåø", "guidance": "Confess if needed.", "scripture": "Repent ye therefore, and be converted, that your sins may be blotted out. (Acts 3:19 KJV)", "example": "Example: 'I am forgiven and I care for myself every day.'"},
    {"key": "thanksgiving", "prompt": "üåø Thanksgiving üåø", "guidance": "Thank God.", "scripture": "In every thing give thanks: for this is the will of God in Christ Jesus concerning you. (1 Thessalonians 5:18 KJV)", "example": "Example: 'Thank You for my health. I am strong and well always.'"},
    {"key": "request_healing", "prompt": "üåø Request Healing / Strength üåø", "guidance": "Ask for healing.", "scripture": "He healeth the broken in heart, and bindeth up their wounds. (Psalm 147:3 KJV)", "example": "Example: 'I am healed and full of strength every day.'"},
    {"key": "closing", "prompt": "üåø Amen üåø", "guidance": "Seal your prayer.", "scripture": "", "example": "Example: 'Amen.'"}
  ],
  "justice": [
    {"key": "wrong", "prompt": "‚öñÔ∏è State Wrong / Injustice ‚öñÔ∏è", "guidance": "Describe the injustice.", "scripture": "But let judgment run down as waters, and righteousness as a mighty stream. (Amos 5:24 KJV)", "example": "Example: 'Justice is done and things are made right.'"},
    {"key": "call_justice", "prompt": "‚öñÔ∏è Call for God's Justice ‚öñÔ∏è", "guidance": "Ask for justice.", "scripture": "For I the LORD love judgment. (Isaiah 61:8 KJV)", "example": "Example: 'God makes things right and justice always prevails.'"},
    {"key": "declare_confidence", "prompt": "‚öñÔ∏è Declare Confidence in God's Righteousness ‚öñÔ∏è", "guidance": "Seal your prayer.", "scripture": "For the LORD is righteous, he loveth righteousness: his countenance doth behold the upright. (Psalm 11:7 KJV)", "example": "Example: 'I trust You to bring justice and I see Your righteousness every day.'"},
    {"key": "closing", "prompt": "‚öñÔ∏è Amen ‚öñÔ∏è", "guidance": "Seal your prayer.", "scripture": "", "example": "Example: 'Amen.'"}
  ]
};

// Store the current prayer data
let currentCategory = '';
let prayerData = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Dismiss keyboard ‚Äî blur active input so keyboard stays hidden
function dismissKeyboard() {
  if (document.activeElement && document.activeElement !== document.body) {
    document.activeElement.blur();
  }
}

// Confetti burst ‚Äî canvas-based particle effect
function launchConfetti() {
  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999';
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const colors = ['#a78bfa','#fcd34d','#7de8b8','#ddd6fe','#bae6fd','#fff'];
  const particles = Array.from({length: 100}, () => ({
    x: canvas.width / 2,
    y: canvas.height / 2,
    vx: (Math.random() - 0.5) * 14,
    vy: (Math.random() - 0.5) * 14 - 5,
    color: colors[Math.floor(Math.random() * colors.length)],
    size: Math.random() * 7 + 2,
    life: 1
  }));
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let alive = false;
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.012;
      if (p.life > 0) {
        alive = true;
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
      }
    });
    if (alive) requestAnimationFrame(animate);
    else canvas.remove();
  }
  animate();
}

// Typewriter effect ‚Äî types text character by character
function typewriterEffect(element, text, speed = 20) {
  element.textContent = '';
  let i = 0;
  function type() {
    if (i < text.length) {
      element.textContent += text.charAt(i);
      i++;
      setTimeout(type, speed);
    }
  }
  type();
}

// Update progress bar as user fills in prayer steps
function updateProgress() {
  const textareas = document.querySelectorAll('#prayer-steps-container textarea');
  const filled = [...textareas].filter(t => t.value.trim().length > 0).length;
  const pct = (filled / textareas.length) * 100;
  const bar = document.getElementById('prayer-progress');
  if (bar) bar.style.width = pct + '%';
  textareas.forEach(t => {
    const step = t.closest('.prayer-step');
    if (step) step.classList.toggle('completed', t.value.trim().length > 0);
  });
}

// Generate a prayer code using English gematria (A=1, B=2, etc.)
function generatePrayerCode(text, length = 6) {
  let total = 0;
  for (let i = 0; i < text.length; i++) {
    const char = text[i].toUpperCase();
    if (/[A-Z]/.test(char)) {
      total += char.charCodeAt(0) - 64;
    } else if (/[0-9]/.test(char)) {
      total += parseInt(char);
    }
  }
  return String(total % (10 ** length));
}

// Build the prayer text from the collected data
function buildPrayerText(data) {
  return Object.values(data).join(' ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RETENTION: Prayer History, Streaks, Milestones
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function savePrayerToHistory(code, prayerText, category) {
  const history = JSON.parse(localStorage.getItem('prayerHistory') || '[]');
  history.unshift({
    code, prayer: prayerText, category,
    date: new Date().toISOString(), id: Date.now()
  });
  if (history.length > 50) history.pop();
  localStorage.setItem('prayerHistory', JSON.stringify(history));
  renderPrayerHistory();
}

function renderPrayerHistory() {
  const history = JSON.parse(localStorage.getItem('prayerHistory') || '[]');
  const list = document.getElementById('prayer-history-list');
  const empty = document.getElementById('history-empty');
  if (!list) return;
  if (!history.length) {
    if (empty) empty.style.display = 'block';
    list.innerHTML = '';
    return;
  }
  if (empty) empty.style.display = 'none';
  list.innerHTML = history.slice(0, 10).map(h => `
    <div class="prayer-history-item">
      <div class="history-header">
        <span class="history-code">${h.code}</span>
        <span class="history-date">${new Date(h.date).toLocaleDateString()}</span>
      </div>
      <div class="history-preview">${h.prayer.substring(0, 120)}${h.prayer.length > 120 ? '...' : ''}</div>
    </div>
  `).join('');
}

function updateStreak() {
  const today = new Date().toDateString();
  const data = JSON.parse(localStorage.getItem('prayerStreak') || '{"count":0,"lastDate":""}');
  const lastDate = data.lastDate ? new Date(data.lastDate).toDateString() : '';
  if (lastDate === today) return data.count;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  if (lastDate === yesterday.toDateString()) {
    data.count++;
  } else {
    data.count = 1;
  }
  data.lastDate = today;
  localStorage.setItem('prayerStreak', JSON.stringify(data));
  return data.count;
}

function renderStreak() {
  const data = JSON.parse(localStorage.getItem('prayerStreak') || '{"count":0,"lastDate":""}');
  const count = data.count || 0;
  let badge = document.getElementById('streak-badge');
  if (!badge) {
    badge = document.createElement('div');
    badge.id = 'streak-badge';
    badge.className = 'streak-badge';
    const logo = document.querySelector('.logo-container');
    if (logo) logo.appendChild(badge);
  }
  badge.innerHTML = count > 0 ? `&#128293; ${count}-day prayer streak` : '';
}

function incrementPrayerCount() {
  let count = parseInt(localStorage.getItem('totalPrayers') || '0') + 1;
  localStorage.setItem('totalPrayers', String(count));
  const milestones = [1, 5, 10, 25, 50, 100, 250, 500];
  if (milestones.includes(count)) {
    setTimeout(() => {
      showToast(`&#127881; Milestone: ${count} prayers created!`, 5000);
      launchConfetti();
    }, 2000);
  }
  return count;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getShareText(code) {
  return `My Prayer Code: ${code}\n\nPray this code with me to amplify our prayers.\nCreate yours at prayercodes.com &#128591;`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Category card click
document.querySelectorAll('.category-card').forEach(card => {
  card.addEventListener('click', function() {
    dismissKeyboard();
    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
    this.classList.add('selected');
    currentCategory = this.getAttribute('data-category');
    prayerData = {};
    buildPrayerSteps(currentCategory);
    document.getElementById('prayer-builder').style.display = 'block';
    setTimeout(() => {
      dismissKeyboard();
      document.getElementById('prayer-builder').scrollIntoView({ behavior: 'smooth' });
    }, 50);
  });
});

// Build the prayer steps with progress bar
function buildPrayerSteps(category) {
  const stepsContainer = document.getElementById('prayer-steps-container');
  const steps = categoryFlows[category];

  // Progress bar + steps
  let html = '<div class="progress-bar-container"><div class="progress-bar-fill" id="prayer-progress"></div></div>';
  steps.forEach((step, index) => {
    html += `
      <div class="prayer-step">
        <div class="prayer-step-header">
          <div class="prayer-step-icon">${step.prompt.split(' ')[0]}</div>
          <div class="prayer-step-title">${step.prompt}</div>
        </div>
        <div class="prayer-step-guidance">${step.guidance}</div>
        <div class="scripture-quote">${step.scripture}</div>
        <div class="form-group">
          <textarea id="step-${index}" data-key="${step.key}" rows="3" placeholder="${step.example}"></textarea>
        </div>
      </div>
    `;
  });
  stepsContainer.innerHTML = html;

  // Attach progress listeners
  document.querySelectorAll('#prayer-steps-container textarea').forEach(ta => {
    ta.addEventListener('input', updateProgress);
  });
}

// Preview Prayer
document.getElementById('preview-prayer').addEventListener('click', function() {
  dismissKeyboard();
  const textareas = document.querySelectorAll('#prayer-steps-container textarea');
  let allFilled = true;
  textareas.forEach(textarea => {
    const key = textarea.getAttribute('data-key');
    const value = textarea.value.trim();
    if (!value) {
      allFilled = false;
      textarea.classList.add('error');
    } else {
      textarea.classList.remove('error');
      prayerData[key] = value;
    }
  });
  if (!allFilled) {
    showToast('Please fill in all prayer sections');
    return;
  }
  const prayerText = buildPrayerText(prayerData);
  document.getElementById('prayer-preview-card').style.display = 'block';
  // Typewriter effect for the preview
  setTimeout(() => {
    dismissKeyboard();
    document.getElementById('prayer-preview-card').scrollIntoView({ behavior: 'smooth' });
    typewriterEffect(document.getElementById('prayer-preview-text'), prayerText);
  }, 50);
});

// Edit Prayer
document.getElementById('edit-prayer').addEventListener('click', function() {
  dismissKeyboard();
  setTimeout(() => {
    document.getElementById('prayer-builder').scrollIntoView({ behavior: 'smooth' });
  }, 50);
});

// Generate Code ‚Äî with scramble animation + confetti
document.getElementById('generate-code').addEventListener('click', function() {
  dismissKeyboard();
  const prayerText = document.getElementById('prayer-preview-text').textContent;
  const finalCode = generatePrayerCode(prayerText);
  const codeEl = document.getElementById('prayer-code');

  document.getElementById('prayer-code-card').style.display = 'block';
  setTimeout(() => {
    dismissKeyboard();
    document.getElementById('prayer-code-card').scrollIntoView({ behavior: 'smooth' });
  }, 50);

  // Scramble animation ‚Äî random digits cycling before reveal
  let iterations = 0;
  const maxIterations = 25;
  const interval = setInterval(() => {
    codeEl.textContent = Array.from({length: Math.max(finalCode.length, 4)}, () =>
      Math.floor(Math.random() * 10)).join('');
    iterations++;
    if (iterations >= maxIterations) {
      clearInterval(interval);
      codeEl.textContent = finalCode;
      codeEl.classList.add('glow-effect', 'fade-in');
      launchConfetti();

      // Save to history, update streak, check milestones
      savePrayerToHistory(finalCode, prayerText, currentCategory);
      updateStreak();
      renderStreak();
      incrementPrayerCount();

      // Pulse share buttons after reveal
      setTimeout(() => {
        document.querySelectorAll('.social-button').forEach(btn => {
          btn.classList.add('glow-effect');
          setTimeout(() => btn.classList.remove('glow-effect'), 4000);
        });
      }, 1500);
    }
  }, 60);
});

// Copy Code
document.getElementById('copy-code').addEventListener('click', function(e) {
  e.preventDefault();
  const code = document.getElementById('prayer-code').textContent;
  navigator.clipboard.writeText(code);
  showToast('Prayer Code copied to clipboard &#128203;');
});

// Native Share (mobile share sheet)
document.getElementById('native-share').addEventListener('click', async function(e) {
  e.preventDefault();
  const code = document.getElementById('prayer-code').textContent;
  const shareData = {
    title: 'My Prayer Code',
    text: `My Prayer Code: ${code}\n\nPray this code with me to amplify our prayers.\nCreate yours at prayercodes.com`,
    url: 'https://prayercodes.com'
  };
  if (navigator.share) {
    try { await navigator.share(shareData); }
    catch(err) { /* user cancelled */ }
  } else {
    navigator.clipboard.writeText(shareData.text);
    showToast('Prayer code copied ‚Äî paste it anywhere!');
  }
});

// WhatsApp Share
document.getElementById('share-whatsapp').addEventListener('click', function(e) {
  e.preventDefault();
  const code = document.getElementById('prayer-code').textContent;
  const msg = `My Prayer Code: ${code}\n\nPray this code with me! Create yours at prayercodes.com`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
});

// Share on Facebook
document.getElementById('share-facebook').addEventListener('click', function(e) {
  e.preventDefault();
  const code = document.getElementById('prayer-code').textContent;
  const shareText = `My Prayer Code: ${code}\n\nPray this code with me to amplify our prayers.\nCreate your own at prayercodes.com`;
  const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://prayercodes.com')}&quote=${encodeURIComponent(shareText)}`;
  window.open(shareUrl, '_blank');
});

// Share on Twitter
document.getElementById('share-twitter').addEventListener('click', function(e) {
  e.preventDefault();
  const code = document.getElementById('prayer-code').textContent;
  const shareText = `My Prayer Code: ${code}\n\nPray this code with me to amplify our prayers.\nCreate your own at prayercodes.com`;
  const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
  window.open(shareUrl, '_blank');
});

// New Prayer
document.getElementById('new-prayer').addEventListener('click', function() {
  dismissKeyboard();
  document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('prayer-builder').style.display = 'none';
  document.getElementById('prayer-preview-card').style.display = 'none';
  document.getElementById('prayer-code-card').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const taglines = [
  "Create structured prayers inspired by scripture, generate your Prayer Code, and connect to the Kingdom of Heaven.",
  "Let your prayers be guided by biblical structure and amplified by the sound of creation.",
  "Build prayers that align with God's Word, generate your unique code, and strengthen your connection to Heaven.",
  "Prayer Codes: Where ancient biblical wisdom meets modern spiritual practice.",
  "Your prayers encoded, your faith amplified, your connection to Heaven strengthened.",
  "Structured prayer leads to focused faith. Generate your code and amplify your connection to God.",
  "The Kingdom of Heaven awaits your prayers. Create, encode, and connect with Prayer Codes."
];

document.addEventListener('DOMContentLoaded', function() {
  // Daily tagline
  const date = new Date();
  const dayOfMonth = date.getDate();
  const taglineIndex = dayOfMonth % taglines.length;
  document.getElementById('tagline').textContent = taglines[taglineIndex];

  // Render prayer history and streak
  renderPrayerHistory();
  renderStreak();

  // Welcome back banner for returning users
  const history = JSON.parse(localStorage.getItem('prayerHistory') || '[]');
  if (history.length > 0) {
    const last = history[0];
    const banner = document.createElement('div');
    banner.className = 'card welcome-back-card';
    banner.innerHTML = `
      <h3 class="text-center">Welcome Back! &#128591;</h3>
      <p class="text-center">Your last Prayer Code: <strong style="color:var(--divine-gold);font-size:1.3rem;">${last.code}</strong></p>
      <p class="text-center" style="opacity:0.7;font-size:0.9rem;">Created ${new Date(last.date).toLocaleDateString()}</p>
      <div class="button-container">
        <button class="button" onclick="this.closest('.card').remove()">Create New Prayer</button>
      </div>
    `;
    document.querySelector('.main-content').prepend(banner);
  }
});
</script>
{% endblock %}
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>